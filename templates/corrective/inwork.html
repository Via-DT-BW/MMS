{% extends 'corrective/corrective.html' %} {% block content %}
<style>
  .working-row {
    background-color: #d1e7dd !important;
    font-size: 1.05rem;
  }
</style>

<div class="col-md-12">{% include "messages/messages.html" %}</div>

<div class="card mt-4 mb-4">
  <div class="card-header">
    <div class="d-flex justify-content-start align-items-center mb-3">
      <h5 class="m-0 text-center col-lg-12">Manutenções Em Curso</h5>
    </div>

    <form method="GET" action="/inwork" class="form-row justify-content-center">
      <div class="form-group col-md-4 col-sm-6 col-12 text-center">
        <small class="form-text text-muted">Filtrar por equipamento</small>
        <input
          type="text"
          name="filter"
          class="form-control"
          placeholder="Equipamento"
          value="{{ request.args.get('filter', '') }}" />
      </div>

      <div class="form-group col-md-4 col-sm-6 col-12 text-center">
        <small class="form-text text-muted"
          >Filtrar por linha de produção</small
        >
        <input
          type="text"
          name="filter_prod_line"
          class="form-control"
          placeholder="Linha de Produção"
          value="{{ request.args.get('filter_prod_line', '') }}" />
      </div>

      <div class="form-group col-md-4 col-sm-6 col-12 text-center">
        <small class="form-text text-muted">Data inicial</small>
        <input
          type="date"
          name="start_date"
          class="form-control"
          value="{{ request.args.get('start_date', '') }}" />
      </div>

      <div class="form-group col-md-4 col-sm-6 col-12 text-center">
        <small class="form-text text-muted">Data final</small>
        <input
          type="date"
          name="end_date"
          class="form-control"
          value="{{ request.args.get('end_date', '') }}" />
      </div>

      <div class="form-group col-md-4 col-sm-6 text-center">
        <small class="form-text text-muted">Itens por página</small>
        <input
          type="number"
          name="page_size"
          class="form-control"
          value="{{ request.args.get('page_size', 10) }}"
          min="1"
          max="100"
          placeholder="Itens por página" />
      </div>

      <div
        class="form-group col-md-4 col-sm-6 d-flex align-items-end justify-content-center">
        <button type="submit" class="btn btn-primary mr-2">
          <i class="fas fa-filter"></i> Filtrar
        </button>
        <a href="/inwork" class="btn btn-danger">Limpar</a>
      </div>
    </form>
  </div>

  <div class="card-body table-responsive">
    {% if ongoing|length == 0 %}
    <p class="text-center">Sem Pedidos de Manutenção Em Curso</p>
    {% else %}
    <table class="table" id="inwork">
      <thead>
        <tr>
          <th>Linha de Produção</th>
          <th>Técnico (último)</th>
          <th>Descrição</th>
          <th>Data de Início</th>
          <th>Equipamento</th>
          <th>Parou Produção?</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for ongo in ongoing %}
        <tr
          {%
          if
          ongo.id_corretiva
          in
          tecnico_in_works
          %}class="working-row"
          {%
          endif
          %}>
          <td>{{ ongo.prod_line }}</td>
          <td>{{ ongo.nome}} - {{ongo.n_tecnico }}</td>
          <td>{{ ongo.description }}</td>
          <td class="data">{{ ongo.data_inicio }}</td>
          <td>{{ ongo.equipament }}</td>
          <td>{{ ongo.stopped_production }}</td>
          <td>
            <button
              class="btn btn-info btn-md"
              data-toggle="modal"
              data-target="#detailsModal"
              data-id="{{ ongo.id }}"
              data-description="{{ ongo.description }}"
              data-equipament="{{ ongo.equipament }}"
              data-functional-location="{{ ongo.functional_location }}"
              data-sap-state="{{ ongo.SAPState }}"
              data-sms-state="{{ ongo.SMSState }}"
              data-sms-date="{{ ongo.sms_date }}"
              data-main-workcenter="{{ ongo.main_workcenter }}">
              <i class="fas fa-eye"></i>
            </button>
            <button
              class="btn btn-secondary btn-md"
              data-toggle="modal"
              data-target="#commentsModal"
              data-id="{{ ongo.id }}"
              data-id-corretiva="{{ ongo.id_corretiva }}"
              data-description="{{ ongo.description }}"
              data-prod-line="{{ ongo.prod_line }}"
              data-equipament="{{ ongo.equipament }}"
              data-ini-date="{{ ongo.data_inicio_man }}"
              data-pedido-date="{{ ongo.data_pedido }}">
              <i class="fa-solid fa-users"></i>
            </button>
            <button
              class="btn btn-warning btn-md"
              onclick="toggleComments({{ ongo.id_corretiva }})">
              <i class="fa-regular fa-rectangle-list"></i>
            </button>
            {% if ongo.id_corretiva not in tecnico_in_works %}
            <button
              class="btn btn-primary btn-md"
              data-id-corretiva="{{ ongo.id_corretiva }}"
              onclick="associateTechnician(this)">
              <i class="fa-solid fa-user-plus ml-1"></i>
            </button>
            {% endif %}
          </td>
        </tr>
        <tr></tr>
        <tr
          id="comments-{{ ongo.id_corretiva }}"
          class="comment-row"
          style="display: none">
          <td colspan="10" class="bg-light">
            <table class="table table-striped mt-3">
              <thead>
                <tr style="background-color: white">
                  <th>Nº Técnico</th>
                  <th>Técnico</th>
                  <th>Comentário</th>
                  <th>Tipo de Avaria</th>
                  <th>Duração (minutos)</th>
                  <th>Data Início</th>
                  <th>Data Fim</th>
                </tr>
              </thead>
              <tbody class="comments-table-body"></tbody>
            </table>
          </td>
        </tr>

        {% endfor %}
      </tbody>
    </table>
    {% include "components/pagination.html" %} {% endif %}
  </div>
</div>

{% include "corrective/components/detailsModal.html" %} {% include
"corrective/components/finishModal.html" %} {% include
"corrective/components/commentsModal.html" %}

<style>
  #inwork tbody tr:nth-child(odd) {
    background-color: #f2f2f2;
  }

  #inwork tbody tr:nth-child(even) {
    background-color: white;
  }
  #inwork tbody tr:hover {
    background-color: #00386c !important;
    color: white;
  }
</style>
<script>
  {% include "corrective/js/toggleComments.js" %}

  function associateTechnician(button) {
    var idCorretiva = $(button).data("id-corretiva");
    var tecnicoLogadoId = "{{ session['id_mt'] }}";

    if (!tecnicoLogadoId) {
      alert("Por favor, selecione um técnico para associar.");
      return;
    }

    $.ajax({
      type: "GET",
      url: "/api/check_association",
      data: {
        id_corretiva: idCorretiva,
        id_tecnico: tecnicoLogadoId,
      },
      success: function (data) {
        if (data.associado) {
          alert("Você já está associado a esta manutenção.");
          return;
        }

        var confirmation = confirm(
          "Tem a certeza de que deseja se associar a esta manutenção?"
        );

        if (confirmation) {
          $.ajax({
            type: "POST",
            url: "/api/associate_tecnico",
            data: {
              id_corretiva: idCorretiva,
              id_tecnico: tecnicoLogadoId,
            },
            success: function (response) {
              if (response.status === "success") {
                $("#commentsModal").modal("hide");
                window.location.href = "/corrective";
              } else {
                alert(response.message);
              }
            },
            error: function () {
              alert("Erro ao associar o técnico.");
            },
          });
        } else {
          console.log("Associação cancelada.");
        }
      },
      error: function () {
        alert("Erro ao verificar a associação.");
      },
    });
  }

  {% include "corrective/js/openModal.js" %}
  {% include "corrective/js/comments.js" %}
</script>

{% endblock %}
